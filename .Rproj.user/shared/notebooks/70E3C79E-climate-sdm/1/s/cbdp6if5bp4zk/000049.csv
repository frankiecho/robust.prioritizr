"0","set.seed(19895894)"
"0","N <- 10"
"0",""
"0","# Prepare baseline temperature and precipitation simulated data"
"0","m <- expand.grid(prec = seq(900, 1200, length.out = N),"
"0","                 temp = seq(16, 20, length.out = N))"
"0",""
"0","temp <- matrix(m$temp + rnorm(N^2, 0, 0.2), N, N, byrow = TRUE)"
"0","prec <- matrix(m$prec + rnorm(N^2, 0, 20), N, N, byrow = TRUE)"
"0",""
"0","# Find the coefficients of the model given the optimal temp/ prec and shape of the quadratic function"
"0","beta_coefs <- function(T_opt, P_opt, k_T, k_P, peak = 10) {"
"0","  beta_0 <- log(peak) + T_opt^2 * k_T/2 + P_opt^2 * k_P/2"
"0","  beta_1 <- -k_T * T_opt"
"0","  beta_2 <- k_T/2"
"0","  beta_3 <- -k_P * P_opt"
"0","  beta_4 <- k_P / 2"
"0","  return(cbind(beta_0, beta_1, beta_2, beta_3, beta_4))"
"0","}"
"0",""
"0","# Specify climate abundance response function of the species, assume that its probability of occurrence"
"0","# follow a multivariate Gaussian distribution of temperature and precipitation"
"0","ab_function <- function(temp, prec, betas, sigma = 0, return_vec = F) {"
"0","  t <- as.vector(temp)"
"0","  p <- as.vector(prec)"
"0","  model_matrix <- cbind(1, t, t^2, p, p^2)"
"0","  betas <- as.vector(betas)"
"0",""
"0","  v <- exp(model_matrix %*% betas + rnorm(length(t))*sigma)"
"0","  if (return_vec) return(as.vector(v))"
"0","  return(matrix(v, nrow = nrow(temp), ncol = ncol(temp)))"
"0","}"
"0",""
"0","# Define function for drawing random abundance numbers based on expected abundance numbers"
"0","rpois_matrix <- function(exp_ab) {"
"0","  dim <- dim(exp_ab)"
"0","  rpois(dim[1]*dim[2], as.vector(exp_ab)) %>%"
"0","    matrix(nrow = dim[1], ncol = dim[2])"
"0","}"
"0",""
"0","# Define a function that can draw abundance values based on temperature, precipitation and a matrix of beta"
"0","ab_draw_pois <- function(t, p, beta) {"
"0","  beta_rand <- as.vector(beta[sample(1:nrow(beta), 1),])"
"0","  exp_ab <- function(t, p,...) ab_function(t, p, beta_rand,...)"
"0","  rpois_matrix(exp_ab(temp, prec))"
"0","}"
"0",""
"0",""
"0","beta_species_1 <- beta_coefs(18.5, 1000, -.3, -.005, 10)"
"0","beta_species_2 <- beta_coefs(20, 1000, -.1, -.0001, 8)"
"0",""
"0","# Define functions for species 1 and 2, controlling mu for their optimal temperature and precipitation, "
"0","# and sigma for the range it can survive in, Ntrials for scaling the absolute number of occurrences"
"0","exp_ab_1 <- function(t, p,...) ab_function(t, p, beta_species_1,...)"
"0","exp_ab_2 <- function(t, p, ...) ab_function(t, p, beta_species_2,...)"
"0",""
"0","# Uncertainty in the beta parameters - suppose we estimate a model and get confidence intervals like this, use this later"
"0","beta_species_dist_1 <- beta_coefs(18.5+rnorm(100), 1000+rnorm(100)*50, -.5, -.005, 10)"
"0","beta_species_dist_2 <- beta_coefs(20+rnorm(100), 1000+rnorm(100)*50, -.1, -.0001, 8)"
"0",""
"0","# Plot climate response of species 1 and 2 in terms of expected abundance"
"0","x <- seq(10, 30, 0.01)"
"0","resp_1 <- exp_ab_1(x, 1000, return_vec = T)"
"0","resp_2 <- exp_ab_2(matrix(x), 1000, return_vec = T)"
"0",""
"0","data.frame(x, resp_1, resp_2) %>%"
"0","  pivot_longer(c('resp_1', 'resp_2')) %>%"
"0","  mutate(name = factor(name, c('resp_1', 'resp_2'), c('Species 1', 'Species 2'))) %>%"
"0","  ggplot(aes(x = x, y = value, color = name)) +"
"0","  geom_line() +"
"0","  theme_bw() +"
"0","  labs(y = 'Expected abundance', x = 'Temperature') +"
"0","  theme(panel.grid = element_blank()) +"
"0","  ggtitle(""Expected abundance of Species 1 and 2"")"
